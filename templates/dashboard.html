{% extends "base.html" %}
{% block content %}

<!-- KPIs: their own row so charts donâ€™t wrap beside them -->
<div class="row g-3">
  <!-- use col-6 (2 per row on phones), col-md-3 (4 per row), col-xl-2 (6 per row) -->
  <div class="col-6 col-md-3 col-xl-2">
    <div class="card kpi"><div class="label">Revenue (Last 30d)</div><div id="rev30" class="value">--</div></div>
  </div>
  <div class="col-6 col-md-3 col-xl-2">
    <div class="card kpi"><div class="label">Invoices(To Paid)</div><div id="outstanding" class="value">--</div></div>
  </div>
  <div class="col-6 col-md-3 col-xl-2">
    <div class="card kpi"><div class="label">Active Projects</div><div id="activeProjects" class="value">--</div></div>
  </div>
  <div class="col-6 col-md-3 col-xl-2">
    <div class="card kpi"><div class="label">Hours Logged (30d)</div><div id="hours30" class="value">--</div></div>
  </div>
  <div class="col-6 col-md-3 col-xl-2">
    <div class="card kpi"><div class="label">Expenses (Last 30d)</div><div id="exp30" class="value">--</div></div>
  </div>
  <div class="col-6 col-md-3 col-xl-2">
  <div class="card kpi"><div class="label">Profit / Loss (30d)</div><div id="pl30" class="value">--</div></div>
    </div>

</div>

<!-- Charts: separate row so they align perfectly -->
<div class="row g-3 mt-2">
  <div class="col-12 col-lg-6">
    <div class="card chart-box">
      <h6 class="mb-3">Revenue by Month</h6>
      <canvas id="revenueChart"></canvas>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="card chart-box">
      <h6 class="mb-3">Invoice Status</h6>
      <canvas id="invoiceStatusChart"></canvas>
    </div>
  </div>

  <div class="col-12">
    <div class="card chart-box">
      <h6 class="mb-3">Project Budget vs Spent</h6>
      <canvas id="projectBurnChart"></canvas>
    </div>
  </div>

  <div class="col-12">
    <div class="card chart-box">
      <h6 class="mb-3">Revenue vs Expenses (Monthly)</h6>
      <canvas id="revExpChart"></canvas>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="card chart-box">
      <h6 class="mb-3">Expenses by Category (This Month)</h6>
      <canvas id="expCatChart"></canvas>
    </div>
  </div>
</div>

<script>
  async function getJSON(url){ const r = await fetch(url); return r.json(); }
  const palette = { brand:'#2563eb', brandWeak:'#c7d2fe', success:'#10b981', warning:'#f59e0b', danger:'#ef4444', muted:'#94a3b8', grid:'#e2e8f0', axis:'#64748b' };
  const axisMinimal = { grid:{ color:palette.grid, drawBorder:false, tickLength:0 }, ticks:{ color:palette.axis, padding:6 } };

  (async () => {
    // KPIs
    const summary = await getJSON('/api/summary/');
    const fmt = (n)=> Number(n||0).toLocaleString();
    document.getElementById('rev30').innerText = fmt(summary.revenue_30d);
    document.getElementById('outstanding').innerText = fmt(summary.outstanding);
    document.getElementById('activeProjects').innerText = summary.active_projects;
    document.getElementById('hours30').innerText = (summary.hours_30d || 0).toFixed(1);
    document.getElementById('exp30').innerText = fmt(summary.expenses_30d || 0);
    // Profit/Loss = revenue - expenses (green if profit, red if loss)
    const diff = (summary.revenue_30d || 0) - (summary.expenses_30d || 0);
    const plEl = document.getElementById('pl30');
    plEl.innerText = (diff >= 0 ? '+' : '-') + fmt(Math.abs(diff));
    plEl.style.color = diff >= 0 ? 'var(--success)' : 'var(--danger)';


    // Revenue line
    const rev = await getJSON('/api/revenue_by_month/');
    const revCtx = document.getElementById('revenueChart').getContext('2d');
    const grad = revCtx.createLinearGradient(0,0,0,220); grad.addColorStop(0,'rgba(37,99,235,0.20)'); grad.addColorStop(1,'rgba(37,99,235,0.00)');
    new Chart(revCtx, {
      type:'line',
      data:{ labels:rev.labels, datasets:[{ label:'Revenue', data:rev.data, borderColor:palette.brand, backgroundColor:grad, borderWidth:2, tension:.35, pointRadius:2, pointHoverRadius:3, fill:true }]},
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, tooltip:{intersect:false, mode:'index'} }, scales:{ x:axisMinimal, y:axisMinimal } }
    });

    // Invoice status donut
    const inv = await getJSON('/api/invoice_status/');
    const colorMap = { Paid:palette.success, Sent:palette.brand, Draft:palette.muted, Overdue:palette.danger };
    const donutColors = inv.labels.map(l => colorMap[l] || palette.brandWeak);
    new Chart(document.getElementById('invoiceStatusChart').getContext('2d'), {
      type:'doughnut',
      data:{ labels:inv.labels, datasets:[{ data:inv.data, backgroundColor:donutColors, borderWidth:0, borderRadius:0, spacing:0 }]},
      options:{ responsive:true, maintainAspectRatio:true, aspectRatio:1, cutout:'84%', rotation:-90, plugins:{ legend:{ position:'top', labels:{ usePointStyle:true, boxWidth:10 } } } }
    });

    // Project budget vs spent
    const burn = await getJSON('/api/project_burn/');
    new Chart(document.getElementById('projectBurnChart').getContext('2d'), {
      type:'bar',
      data:{ labels:burn.labels, datasets:[
        { label:'Budget', data:burn.budget, backgroundColor:palette.brandWeak, borderWidth:0, borderRadius:8, maxBarThickness:26, categoryPercentage:.6, barPercentage:.8 },
        { label:'Spent',  data:burn.spent,  backgroundColor:palette.brand,     borderWidth:0, borderRadius:8, maxBarThickness:26, categoryPercentage:.6, barPercentage:.8 }
      ]},
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'top' } }, scales:{ x:axisMinimal, y:axisMinimal } }
    });

    // Revenue vs Expenses (monthly)
    const rx = await getJSON('/api/revenue_vs_expenses/');
    new Chart(document.getElementById('revExpChart').getContext('2d'), {
      type:'bar',
      data:{ labels:rx.labels, datasets:[
        { label:'Revenue',  data:rx.revenue,  backgroundColor:'#2563eb', borderWidth:0, borderRadius:6, maxBarThickness:26 },
        { label:'Expenses', data:rx.expenses, backgroundColor:'#ef4444', borderWidth:0, borderRadius:6, maxBarThickness:26 }
      ]},
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'top' } }, scales:{ x:axisMinimal, y:axisMinimal } }
    });

    // Expenses by Category (this month)
    const cat = await getJSON('/api/expenses_by_category/');
    new Chart(document.getElementById('expCatChart').getContext('2d'), {
      type:'doughnut',
      data:{ labels:cat.labels, datasets:[{ data:cat.data, backgroundColor:['#94a3b8','#0ea5e9','#f59e0b','#10b981','#ef4444','#a78bfa','#22d3ee','#fb7185','#84cc16','#f472b6'], borderWidth:0 }]},
      options:{ responsive:true, maintainAspectRatio:false, cutout:'70%', plugins:{ legend:{ position:'top', labels:{ usePointStyle:true, boxWidth:10 } } } }
    });
  })();
</script>
{% endblock %}
